{"ast":null,"code":"var __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nvar __spread = this && this.__spread || function () {\n  for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));\n\n  return ar;\n};\n\nimport { MagicOutgoingWindowMessage, MagicIncomingWindowMessage } from '@magic-sdk/types';\nimport { createMalformedResponseError, MagicRPCError } from '../core/sdk-exceptions';\nimport { standardizeJsonRpcRequestPayload } from '../core/json-rpc';\nimport { createPromiEvent } from '../util/promise-tools';\n\nvar BaseModule =\n/** @class */\nfunction () {\n  function BaseModule(sdk) {\n    this.sdk = sdk;\n  }\n\n  Object.defineProperty(BaseModule.prototype, \"transport\", {\n    /**\n     * The `PayloadTransport` for the SDK instance registered to this module.\n     */\n    get: function () {\n      return this.sdk.transport;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(BaseModule.prototype, \"overlay\", {\n    /**\n     * The `ViewController` for the SDK instance registered to this module.\n     */\n    get: function () {\n      return this.sdk.overlay;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  /**\n   * Emits promisified requests to the Magic `<iframe>` context.\n   */\n\n  BaseModule.prototype.request = function (payload) {\n    var responsePromise = this.transport.post(this.overlay, MagicOutgoingWindowMessage.MAGIC_HANDLE_REQUEST, standardizeJsonRpcRequestPayload(payload)); // PromiEvent-ify the response.\n\n    var promiEvent = createPromiEvent(function (resolve, reject) {\n      responsePromise.then(function (res) {\n        cleanupEvents();\n        if (res.hasError) reject(new MagicRPCError(res.payload.error));else if (res.hasResult) resolve(res.payload.result);else throw createMalformedResponseError();\n      }).catch(function (err) {\n        cleanupEvents();\n        reject(err);\n      });\n    }); // Listen for events from the `<iframe>` associated with the current payload\n    // and emit those to `PromiEvent` subscribers.\n\n    var cleanupEvents = this.transport.on(MagicIncomingWindowMessage.MAGIC_HANDLE_EVENT, function (evt) {\n      var _a;\n\n      var response = evt.data.response;\n\n      if (response.id === payload.id && ((_a = response.result) === null || _a === void 0 ? void 0 : _a.event)) {\n        var _b = response.result,\n            event_1 = _b.event,\n            _c = _b.params,\n            params = _c === void 0 ? [] : _c;\n        promiEvent.emit.apply(promiEvent, __spread([event_1], params));\n      }\n    });\n    return promiEvent;\n  };\n\n  return BaseModule;\n}();\n\nexport { BaseModule };","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,SAAgCA,0BAAhC,EAA4DC,0BAA5D,QAA8F,kBAA9F;AACA,SAASC,4BAAT,EAAuCC,aAAvC,QAA4D,wBAA5D;AAGA,SAASC,gCAAT,QAAiD,kBAAjD;AACA,SAASC,gBAAT,QAAiC,uBAAjC;;AAIA;AAAA;AAAA;AACE,sBAA+BC,GAA/B,EAA2C;AAAZ;AAAgB;;AAK/CC,wBAAcC,oBAAd,EAAc,WAAd,EAAuB;AAHvB;;;SAGA;AACE,aAAQ,KAAKF,GAAL,CAAiBG,SAAzB;AACD,KAFsB;oBAAA;;AAAA,GAAvB;AAOAF,wBAAcC,oBAAd,EAAc,SAAd,EAAqB;AAHrB;;;SAGA;AACE,aAAQ,KAAKF,GAAL,CAAiBI,OAAzB;AACD,KAFoB;oBAAA;;AAAA,GAArB;AAIA;;;;AAGUF,iCAAV,UAA4EG,OAA5E,EAAmH;AACjH,QAAMC,eAAe,GAAG,KAAKH,SAAL,CAAeI,IAAf,CACtB,KAAKH,OADiB,EAEtBV,0BAA0B,CAACc,oBAFL,EAGtBV,gCAAgC,CAACO,OAAD,CAHV,CAAxB,CADiH,CAOjH;;AACA,QAAMI,UAAU,GAAGV,gBAAgB,CAAqB,UAACW,OAAD,EAAUC,MAAV,EAAgB;AACtEL,qBAAe,CACZM,IADH,CACQ,UAACC,GAAD,EAAI;AACRC,qBAAa;AACb,YAAID,GAAG,CAACE,QAAR,EAAkBJ,MAAM,CAAC,IAAId,aAAJ,CAAkBgB,GAAG,CAACR,OAAJ,CAAYW,KAA9B,CAAD,CAAN,CAAlB,KACK,IAAIH,GAAG,CAACI,SAAR,EAAmBP,OAAO,CAACG,GAAG,CAACR,OAAJ,CAAYa,MAAb,CAAP,CAAnB,KACA,MAAMtB,4BAA4B,EAAlC;AACN,OANH,EAOGuB,KAPH,CAOS,UAACC,GAAD,EAAI;AACTN,qBAAa;AACbH,cAAM,CAACS,GAAD,CAAN;AACD,OAVH;AAWD,KAZkC,CAAnC,CARiH,CAsBjH;AACA;;AACA,QAAMN,aAAa,GAAG,KAAKX,SAAL,CAAekB,EAAf,CAAkB1B,0BAA0B,CAAC2B,kBAA7C,EAAiE,UAACC,GAAD,EAAI;;;AACjF;;AACR,UAAIC,QAAQ,CAACC,EAAT,KAAgBpB,OAAO,CAACoB,EAAxB,KAA0B,MAAID,QAAQ,CAACN,MAAb,MAAmB,IAAnB,IAAmBQ,aAAnB,GAAmB,MAAnB,GAAmBA,GAAEC,KAA/C,CAAJ,EAA0D;AAClD;AAAA,YAAEC,kBAAF;AAAA,YAASC,cAAT;AAAA,YAASC,gCAAT;AACNrB,kBAAU,CAACsB,IAAX,CAAeC,KAAf,aAAUC,UAAML,OAAN,GAAgBE,MAAhB,CAAV;AACD;AACF,KANqB,CAAtB;AAQA,WAAOrB,UAAP;AACD,GAjCS;;AAkCZ;AAAC,CAtDD","names":["MagicOutgoingWindowMessage","MagicIncomingWindowMessage","createMalformedResponseError","MagicRPCError","standardizeJsonRpcRequestPayload","createPromiEvent","sdk","Object","BaseModule","transport","overlay","payload","responsePromise","post","MAGIC_HANDLE_REQUEST","promiEvent","resolve","reject","then","res","cleanupEvents","hasError","error","hasResult","result","catch","err","on","MAGIC_HANDLE_EVENT","evt","response","id","_a","event","event_1","_c","params","emit","apply","__spread"],"sourceRoot":"","sources":["../../../src/modules/base-module.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}