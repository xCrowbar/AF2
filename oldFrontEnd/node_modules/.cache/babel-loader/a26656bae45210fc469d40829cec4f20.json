{"ast":null,"code":"import { isBrowser, getLocation, getQueryString, detectEnv, appendToQueryString } from \"@walletconnect/utils\";\nimport NetworkMonitor from \"./network\";\nconst WS = typeof global.WebSocket !== \"undefined\" ? global.WebSocket : require(\"ws\");\n\nclass SocketTransport {\n  constructor(opts) {\n    this.opts = opts;\n    this._queue = [];\n    this._events = [];\n    this._subscriptions = [];\n    this._protocol = opts.protocol;\n    this._version = opts.version;\n    this._url = \"\";\n    this._netMonitor = null;\n    this._socket = null;\n    this._nextSocket = null;\n    this._subscriptions = opts.subscriptions || [];\n    this._netMonitor = opts.netMonitor || new NetworkMonitor();\n\n    if (!opts.url || typeof opts.url !== \"string\") {\n      throw new Error(\"Missing or invalid WebSocket url\");\n    }\n\n    this._url = opts.url;\n\n    this._netMonitor.on(\"online\", () => this._socketCreate());\n  }\n\n  set readyState(value) {}\n\n  get readyState() {\n    return this._socket ? this._socket.readyState : -1;\n  }\n\n  set connecting(value) {}\n\n  get connecting() {\n    return this.readyState === 0;\n  }\n\n  set connected(value) {}\n\n  get connected() {\n    return this.readyState === 1;\n  }\n\n  set closing(value) {}\n\n  get closing() {\n    return this.readyState === 2;\n  }\n\n  set closed(value) {}\n\n  get closed() {\n    return this.readyState === 3;\n  }\n\n  open() {\n    this._socketCreate();\n  }\n\n  close() {\n    this._socketClose();\n  }\n\n  send(message, topic, silent) {\n    if (!topic || typeof topic !== \"string\") {\n      throw new Error(\"Missing or invalid topic field\");\n    }\n\n    this._socketSend({\n      topic: topic,\n      type: \"pub\",\n      payload: message,\n      silent: !!silent\n    });\n  }\n\n  subscribe(topic) {\n    this._socketSend({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    });\n  }\n\n  on(event, callback) {\n    this._events.push({\n      event,\n      callback\n    });\n  }\n\n  _socketCreate() {\n    if (this._nextSocket) {\n      return;\n    }\n\n    const url = getWebSocketUrl(this._url, this._protocol, this._version);\n    this._nextSocket = new WS(url);\n\n    if (!this._nextSocket) {\n      throw new Error(\"Failed to create socket\");\n    }\n\n    this._nextSocket.onmessage = event => this._socketReceive(event);\n\n    this._nextSocket.onopen = () => this._socketOpen();\n\n    this._nextSocket.onerror = event => this._socketError(event);\n\n    this._nextSocket.onclose = () => {\n      setTimeout(() => {\n        this._nextSocket = null;\n\n        this._socketCreate();\n      }, 1000);\n    };\n  }\n\n  _socketOpen() {\n    this._socketClose();\n\n    this._socket = this._nextSocket;\n    this._nextSocket = null;\n\n    this._queueSubscriptions();\n\n    this._pushQueue();\n  }\n\n  _socketClose() {\n    if (this._socket) {\n      this._socket.onclose = () => {};\n\n      this._socket.close();\n    }\n  }\n\n  _socketSend(socketMessage) {\n    const message = JSON.stringify(socketMessage);\n\n    if (this._socket && this._socket.readyState === 1) {\n      this._socket.send(message);\n    } else {\n      this._setToQueue(socketMessage);\n\n      this._socketCreate();\n    }\n  }\n\n  async _socketReceive(event) {\n    let socketMessage;\n\n    try {\n      socketMessage = JSON.parse(event.data);\n    } catch (error) {\n      return;\n    }\n\n    this._socketSend({\n      topic: socketMessage.topic,\n      type: \"ack\",\n      payload: \"\",\n      silent: true\n    });\n\n    if (this._socket && this._socket.readyState === 1) {\n      const events = this._events.filter(event => event.event === \"message\");\n\n      if (events && events.length) {\n        events.forEach(event => event.callback(socketMessage));\n      }\n    }\n  }\n\n  _socketError(e) {\n    const events = this._events.filter(event => event.event === \"error\");\n\n    if (events && events.length) {\n      events.forEach(event => event.callback(e));\n    }\n  }\n\n  _queueSubscriptions() {\n    const subscriptions = this._subscriptions;\n    subscriptions.forEach(topic => this._queue.push({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    }));\n    this._subscriptions = this.opts.subscriptions || [];\n  }\n\n  _setToQueue(socketMessage) {\n    this._queue.push(socketMessage);\n  }\n\n  _pushQueue() {\n    const queue = this._queue;\n    queue.forEach(socketMessage => this._socketSend(socketMessage));\n    this._queue = [];\n  }\n\n}\n\nfunction getWebSocketUrl(_url, protocol, version) {\n  var _a, _b;\n\n  const url = _url.startsWith(\"https\") ? _url.replace(\"https\", \"wss\") : _url.startsWith(\"http\") ? _url.replace(\"http\", \"ws\") : _url;\n  const splitUrl = url.split(\"?\");\n  const params = isBrowser() ? {\n    protocol,\n    version,\n    env: \"browser\",\n    host: ((_a = getLocation()) === null || _a === void 0 ? void 0 : _a.host) || \"\"\n  } : {\n    protocol,\n    version,\n    env: ((_b = detectEnv()) === null || _b === void 0 ? void 0 : _b.name) || \"\"\n  };\n  const queryString = appendToQueryString(getQueryString(splitUrl[1] || \"\"), params);\n  return splitUrl[0] + \"?\" + queryString;\n}\n\nexport default SocketTransport;","map":{"version":3,"mappings":"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","names":["isBrowser","getLocation","getQueryString","detectEnv","appendToQueryString","NetworkMonitor","WS","global","WebSocket","require","SocketTransport","constructor","opts","_protocol","protocol","_version","version","_url","_netMonitor","_socket","_nextSocket","_subscriptions","subscriptions","netMonitor","url","Error","on","_socketCreate","readyState","value","connecting","connected","closing","closed","open","close","_socketClose","send","message","topic","silent","_socketSend","type","payload","subscribe","event","callback","_events","push","getWebSocketUrl","onmessage","_socketReceive","onopen","_socketOpen","onerror","_socketError","onclose","setTimeout","_queueSubscriptions","_pushQueue","socketMessage","JSON","stringify","_setToQueue","parse","data","error","events","filter","length","forEach","e","_queue","queue","startsWith","replace","splitUrl","split","params","env","host","_a","_b","name","queryString"],"sourceRoot":"","sources":["../../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}